name: adversarial-regression

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  adversarial-regression:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cargo clippy
        run: cargo clippy -- -D warnings

      - name: Cargo test
        run: cargo test -q

      - name: Build release binaries
        run: cargo build --release -p paraphina --bin monte_carlo --bin sim_eval

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run Python unit tests
        run: |
          python3 -m unittest discover -s batch_runs/phase_a/tests -p "test_*.py" -q

      - name: Run adversarial search (smoke mode for CI)
        run: |
          python3 -m batch_runs.phase_a.adversarial_search_promote \
            --smoke \
            --out runs/phaseA_adv_search_smoke_ci

      - name: Verify adversarial search evidence
        run: |
          cargo run --release -p paraphina --bin sim_eval -- \
            verify-evidence-tree runs/phaseA_adv_search_smoke_ci

      - name: Run adversarial regression suite v2
        run: |
          if [ -f scenarios/suites/adversarial_regression_v2.yaml ]; then
            echo "Running adversarial regression suite v2 (path-based)..."
            cargo run --release -p paraphina --bin sim_eval -- \
              suite scenarios/suites/adversarial_regression_v2.yaml \
              --output-dir runs/adv_reg_v2_smoke_ci \
              --verbose
            echo "✓ Adversarial regression suite v2 completed"
          else
            echo "No adversarial_regression_v2.yaml found, trying v1..."
            if [ -f scenarios/suites/adversarial_regression_v1.yaml ]; then
              cargo run --release -p paraphina --bin sim_eval -- \
                suite scenarios/suites/adversarial_regression_v1.yaml \
                --output-dir runs/adv_reg_v1_smoke_ci \
                --verbose
              echo "✓ Adversarial regression suite v1 completed"
            else
              echo "No adversarial suite found, skipping"
            fi
          fi

      - name: Verify adversarial suite evidence
        run: |
          # Verify v2 suite output
          if [ -d runs/adv_reg_v2_smoke_ci ]; then
            echo "Verifying evidence packs in runs/adv_reg_v2_smoke_ci..."
            cargo run --release -p paraphina --bin sim_eval -- \
              verify-evidence-tree runs/adv_reg_v2_smoke_ci
            echo "✓ Evidence packs verified"
          # Fallback to v1 output
          elif [ -d runs/adv_reg_v1_smoke_ci ]; then
            echo "Verifying evidence packs in runs/adv_reg_v1_smoke_ci..."
            cargo run --release -p paraphina --bin sim_eval -- \
              verify-evidence-tree runs/adv_reg_v1_smoke_ci
            echo "✓ Evidence packs verified"
          else
            echo "No adversarial suite output found"
          fi

      - name: Check search results
        run: |
          python3 - <<'EOF'
          import json
          from pathlib import Path
          
          topk_path = Path("runs/phaseA_adv_search_smoke_ci/topk.json")
          if not topk_path.exists():
              print("ERROR: topk.json not found")
              exit(1)
          
          with open(topk_path) as f:
              data = json.load(f)
          
          scenarios = data.get("scenarios", [])
          print(f"Promoted {len(scenarios)} adversarial scenarios:")
          
          for s in scenarios:
              print(f"  Rank {s['rank']}: seed={s['seed']}, score={s['adversarial_score']:.2f}")
          
          print("\n✓ Adversarial search completed successfully")
          EOF

      - name: Upload adversarial results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: adversarial-regression-results
          path: |
            runs/phaseA_adv_search_smoke_ci/
            runs/adv_reg_v2_smoke_ci/
            scenarios/suites/adversarial_regression_v2.yaml
            scenarios/v1/adversarial/generated_v1/

