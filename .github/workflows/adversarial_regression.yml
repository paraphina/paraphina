name: adversarial-regression

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  adversarial-regression:
    runs-on: ${{ fromJSON((github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) && '["self-hosted","Linux","X64","vpsb-ci"]' || '["ubuntu-latest"]') }}
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cargo clippy
        run: cargo clippy -- -D warnings

      - name: Cargo test
        run: cargo test -q

      - name: Build release binaries
        run: cargo build --release -p paraphina --bin monte_carlo --bin sim_eval

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run Python unit tests
        run: |
          set -euo pipefail
          python3 -m unittest discover -s batch_runs/phase_a/tests -p "test_*.py" -q

      - name: Run adversarial search (smoke mode for CI)
        run: |
          set -euo pipefail
          rm -rf runs/phaseA_adv_search_smoke_ci
          python3 -m batch_runs.phase_a.adversarial_search_promote \
            --smoke \
            --top-k 3 \
            --out runs/phaseA_adv_search_smoke_ci

      - name: Run adversarial regression suite v2
        run: |
          set -euo pipefail
          rm -rf runs/adv_reg_v2_smoke_ci
          if [ -f scenarios/suites/adversarial_regression_v2.yaml ]; then
            echo "Running adversarial regression suite v2 (path-based)..."
            cargo run --release -p paraphina --bin sim_eval -- \
              suite scenarios/suites/adversarial_regression_v2.yaml \
              --output-dir runs/adv_reg_v2_smoke_ci \
              --verbose
            echo "Adversarial regression suite v2 completed"
          else
            echo "No adversarial_regression_v2.yaml found, skipping suite run"
          fi

      - name: Verify adversarial suite evidence
        run: |
          set -euo pipefail
          if [ -d runs/adv_reg_v2_smoke_ci ]; then
            echo "Verifying evidence packs in runs/adv_reg_v2_smoke_ci..."
            cargo run --release -p paraphina --bin sim_eval -- \
              verify-evidence-tree runs/adv_reg_v2_smoke_ci
            echo "Evidence packs verified"
          else
            echo "No adversarial suite output found, skipping verification"
          fi

      - name: Check search results
        run: |
          set -euo pipefail
          python3 - <<'EOF'
          import json
          import sys
          from pathlib import Path

          topk_path = Path("runs/phaseA_adv_search_smoke_ci/topk.json")
          if not topk_path.exists():
              print("WARNING: topk.json not found at", topk_path)
              print("This may be expected if all candidates failed")
              sys.exit(0)

          try:
              with open(topk_path) as f:
                  data = json.load(f)
          except json.JSONDecodeError as e:
              print(f"ERROR: Invalid JSON in topk.json: {e}")
              sys.exit(1)

          scenarios = data.get("scenarios", [])
          print(f"Promoted {len(scenarios)} adversarial scenarios")

          for s in scenarios:
              score = s.get("adversarial_score", 0)
              seed = s.get("seed", "?")
              rank = s.get("rank", "?")
              print(f"  Rank {rank}: seed={seed}, score={score:.2f}")

          print("Adversarial search completed successfully")
          EOF

      - name: Upload adversarial results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: adversarial-regression-results
          path: |
            runs/phaseA_adv_search_smoke_ci/**
            runs/adv_reg_v2_smoke_ci/**
            scenarios/suites/adversarial_regression_v2.yaml
            scenarios/v1/adversarial/generated_v1/**
