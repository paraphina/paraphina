name: adversarial-regression

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  adversarial-regression:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cargo clippy
        run: cargo clippy -- -D warnings

      - name: Cargo test
        run: cargo test -q

      - name: Build release binaries
        run: cargo build --release -p paraphina --bin monte_carlo --bin sim_eval

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run adversarial search (smoke mode for CI)
        run: |
          python3 batch_runs/exp_phase_a_adversarial_search.py \
            --smoke \
            --out runs/ci_adversarial \
            --top-k 3

      - name: Verify evidence packs for adversarial scenarios
        run: |
          # Find all scenario directories and verify each
          for dir in runs/ci_adversarial/run_*/scenario_*; do
            if [ -d "$dir" ]; then
              echo "Verifying: $dir"
              cargo run --release -p paraphina --bin sim_eval -- verify-evidence-pack "$dir"
            fi
          done

      - name: Check for critical failures
        run: |
          # Parse failure_seeds.json and fail if any scenario has kill_rate > 0
          # This is a safety gate for adversarial regression
          python3 - <<'EOF'
          import json
          import sys
          from pathlib import Path
          
          # Find the latest run directory
          runs_dir = Path("runs/ci_adversarial")
          if not runs_dir.exists():
              print("ERROR: No adversarial run directory found")
              sys.exit(1)
          
          run_dirs = sorted([d for d in runs_dir.iterdir() if d.is_dir() and d.name.startswith("run_")])
          if not run_dirs:
              print("ERROR: No run directories found")
              sys.exit(1)
          
          latest_run = run_dirs[-1]
          failure_seeds_path = latest_run / "failure_seeds.json"
          
          if not failure_seeds_path.exists():
              print(f"ERROR: failure_seeds.json not found in {latest_run}")
              sys.exit(1)
          
          with open(failure_seeds_path) as f:
              data = json.load(f)
          
          failures = data.get("failure_seeds", [])
          print(f"Found {len(failures)} failure seeds")
          
          # In adversarial mode, we expect to find failures.
          # The CI gate is: evidence packs must verify (checked above)
          # and we log the failure seeds for review.
          
          for seed in failures:
              print(f"  Rank {seed['rank']}: {seed['scenario_id']} "
                    f"(kill_ci_upper={seed.get('kill_prob_ci_upper', 'N/A'):.3f})")
          
          print("\nAdversarial regression completed successfully.")
          print("Failure seeds have been logged for review.")
          EOF

      - name: Upload adversarial results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: adversarial-regression-results
          path: |
            runs/ci_adversarial/**/exp_phase_a_adversarial_search_runs.csv
            runs/ci_adversarial/**/exp_phase_a_adversarial_search_summary.csv
            runs/ci_adversarial/**/failure_seeds.json
            runs/ci_adversarial/**/mc_summary.json

      - name: Run adversarial regression suite
        run: |
          if [ -f scenarios/suites/adversarial_regression_v1.yaml ]; then
            echo "Running adversarial regression suite (env_overrides now supported)..."
            cargo run --release -p paraphina --bin sim_eval -- \
              suite scenarios/suites/adversarial_regression_v1.yaml
            echo "✓ Adversarial regression suite completed"
          else
            echo "No adversarial_regression_v1.yaml found, skipping suite run"
          fi

      - name: Verify adversarial suite evidence packs
        run: |
          # The adversarial suite writes to runs/adversarial_regression per its YAML
          if [ -d runs/adversarial_regression ]; then
            echo "Verifying evidence packs in runs/adversarial_regression..."
            cargo run --release -p paraphina --bin sim_eval -- \
              verify-evidence-tree runs/adversarial_regression
            echo "✓ Evidence packs verified"
          else
            echo "No adversarial suite output found"
          fi

