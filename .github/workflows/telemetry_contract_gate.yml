name: telemetry-contract-gate

# Telemetry Contract Gate CI
# Validates that telemetry schemas and tooling are consistent.
#
# Exit codes from check_telemetry_contract.py:
#   0 = OK (all records valid)
#   1 = Contract violation (schema error)
#   2 = File not found, CLI usage error, or unmapped file type

on:
  pull_request:
  push:
    branches: [main]

# Minimal permissions - read-only for contents
permissions:
  contents: read

jobs:
  telemetry-contract-gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Show Python version
        run: python3 --version

      # Run foundational integrity checks first
      - name: Run Unicode controls scanner
        run: python3 tools/check_unicode_controls.py

      - name: Run Docs Integrity Gate
        run: python3 tools/check_docs_integrity.py

      # Validate schema files are valid JSON
      - name: Validate schema files
        run: |
          python3 -c "
          import json
          
          # Validate telemetry_schema_v1.json
          with open('schemas/telemetry_schema_v1.json') as f:
              schema = json.load(f)
          assert 'required_fields' in schema, 'Telemetry schema missing required_fields'
          assert 'field_types' in schema, 'Telemetry schema missing field_types'
          assert schema.get('schema_version') == 1, 'Telemetry schema version must be 1'
          print('✓ schemas/telemetry_schema_v1.json is valid')
          
          # Validate mc_runs_schema_v1.json
          with open('schemas/mc_runs_schema_v1.json') as f:
              schema = json.load(f)
          assert 'required_fields' in schema, 'MC runs schema missing required_fields'
          assert 'field_types' in schema, 'MC runs schema missing field_types'
          assert schema.get('schema_version') == 1, 'MC runs schema version must be 1'
          print('✓ schemas/mc_runs_schema_v1.json is valid')
          "

      # Run Python unit tests for telemetry contract gate
      - name: Run telemetry contract gate Python tests
        run: |
          python3 -m unittest tests.test_telemetry_contract_gate -v

      # Run all Python unit tests
      - name: Run all Python unit tests
        run: python3 -m unittest discover -s tests -p 'test_*.py' -q

      # Build Rust and run telemetry schema tests
      - uses: dtolnay/rust-toolchain@stable

      - name: Run Rust telemetry schema tests
        working-directory: paraphina
        run: |
          cargo test telemetry_schema --release -- --nocapture

      # Build paraphina binary
      - name: Build paraphina binary
        run: cargo build --release -p paraphina

      # Generate per-tick telemetry via paraphina binary (non-vacuous validation)
      - name: Generate per-tick telemetry
        run: |
          echo "=== Generating per-tick telemetry ==="
          mkdir -p runs/ci/telemetry_smoke
          
          PARAPHINA_TELEMETRY_MODE=jsonl \
          PARAPHINA_TELEMETRY_PATH=runs/ci/telemetry_smoke/telemetry.jsonl \
          ./target/release/paraphina --ticks 10 --profile balanced
          
          echo "✓ Per-tick telemetry generated"

      # Hard assertion: expected telemetry file must exist
      - name: Assert telemetry file exists
        run: |
          echo "=== Verifying telemetry artifact exists ==="
          test -f runs/ci/telemetry_smoke/telemetry.jsonl || {
            echo "ERROR: Expected file runs/ci/telemetry_smoke/telemetry.jsonl not found"
            exit 1
          }
          echo "✓ telemetry.jsonl exists"
          echo "File size: $(wc -c < runs/ci/telemetry_smoke/telemetry.jsonl) bytes"
          echo "Record count: $(wc -l < runs/ci/telemetry_smoke/telemetry.jsonl) lines"
          echo "First record (formatted):"
          head -1 runs/ci/telemetry_smoke/telemetry.jsonl | python3 -m json.tool

      # Non-vacuous telemetry contract validation (per-tick)
      - name: Validate per-tick telemetry contract
        run: |
          echo "=== Running Telemetry Contract Gate on per-tick telemetry ==="
          python3 tools/check_telemetry_contract.py runs/ci/telemetry_smoke/telemetry.jsonl

      # Generate MC runs via mc_scale smoke (tests mc_runs.jsonl schema)
      - name: Generate MC runs telemetry
        run: |
          echo "=== Generating MC runs via mc_scale smoke ==="
          rm -rf runs/ci/mc_smoke
          python3 -m batch_runs.phase_a.mc_scale smoke \
            --seed 12345 \
            --runs 6 \
            --shards 2 \
            --ticks 20 \
            --out-dir runs/ci/mc_smoke
          
          echo "✓ MC runs generated"

      # Hard assertion: mc_runs.jsonl must exist
      - name: Assert mc_runs.jsonl exists
        run: |
          echo "=== Verifying mc_runs.jsonl artifact exists ==="
          test -f runs/ci/mc_smoke/mc_runs.jsonl || {
            echo "ERROR: Expected file runs/ci/mc_smoke/mc_runs.jsonl not found"
            exit 1
          }
          echo "✓ mc_runs.jsonl exists"
          echo "File size: $(wc -c < runs/ci/mc_smoke/mc_runs.jsonl) bytes"
          echo "Record count: $(wc -l < runs/ci/mc_smoke/mc_runs.jsonl) lines"
          echo "First record (formatted):"
          head -1 runs/ci/mc_smoke/mc_runs.jsonl | python3 -m json.tool

      # Non-vacuous MC runs contract validation
      - name: Validate MC runs telemetry contract
        run: |
          echo "=== Running Telemetry Contract Gate on MC runs ==="
          python3 tools/check_telemetry_contract.py runs/ci/mc_smoke/mc_runs.jsonl

      # Validate entire MC output directory (tests multi-file validation)
      - name: Validate MC output directory
        run: |
          echo "=== Validating entire MC output directory ==="
          python3 tools/check_telemetry_contract.py runs/ci/mc_smoke/

      # Summary
      - name: CI Summary
        if: always()
        run: |
          echo "=== Telemetry Contract Gate Summary ==="
          echo "✓ Schema files validated"
          echo "✓ Python unit tests passed"
          echo "✓ Rust schema tests passed"
          echo "✓ Per-tick telemetry generated and validated (non-vacuous)"
          echo "✓ MC runs generated and validated (non-vacuous)"
          echo ""
          echo "Schemas:"
          echo "  - schemas/telemetry_schema_v1.json (per-tick telemetry)"
          echo "  - schemas/mc_runs_schema_v1.json (MC runs)"
          echo "Docs:   docs/TELEMETRY_SCHEMA_V1.md"
          echo "Tool:   tools/check_telemetry_contract.py"
