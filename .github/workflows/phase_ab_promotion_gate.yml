name: phase-ab-promotion-gate

# This workflow runs the institutional-grade Phase AB Promotion Gate.
# It is manually triggered (workflow_dispatch) for controlled promotion decisions.
#
# Exit codes (strict mode):
#   0 = PASS (PROMOTE - candidate is provably better)
#   1 = FAIL (REJECT - candidate fails guardrails)
#   2 = HOLD (insufficient evidence - needs more data)
#   3 = ERROR (runtime/IO/parsing failure)

on:
  workflow_dispatch:
    inputs:
      seed:
        description: 'Random seed for reproducibility'
        required: false
        default: '24680'
      n_bootstrap:
        description: 'Number of bootstrap samples'
        required: false
        default: '1000'
      deploy:
        description: 'Auto-deploy on PROMOTE (graduated pipeline)'
        required: false
        type: boolean
        default: false
      deploy_stop_before:
        description: 'Stop deploy before this stage (paper|canary|live). Empty = full deploy.'
        required: false
        default: ''
      shadow_soak:
        description: 'Shadow soak duration in seconds'
        required: false
        default: '300'
      paper_soak:
        description: 'Paper soak duration in seconds'
        required: false
        default: '600'
      canary_soak:
        description: 'Canary soak duration in seconds'
        required: false
        default: '900'

jobs:
  phase-ab-promotion-gate:
    runs-on: ${{ fromJSON((github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) && '["self-hosted","Linux","X64","vpsb-ci"]' || '["ubuntu-latest"]') }}
    outputs:
      decision: ${{ steps.gate.outputs.decision }}
      exit_code: ${{ steps.gate.outputs.exit_code }}
    steps:
      - uses: actions/checkout@v4

      - name: Check for forbidden Unicode control characters
        run: python3 tools/check_unicode_controls.py

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build release binaries
        run: cargo build --release -p paraphina --bin monte_carlo --bin sim_eval

      - name: Configure sim_eval binary path
        run: |
          echo "SIM_EVAL_BIN=$GITHUB_WORKSPACE/target/release/sim_eval" >> $GITHUB_ENV
          echo "$GITHUB_WORKSPACE/target/release" >> $GITHUB_PATH
          echo "Configured SIM_EVAL_BIN=$GITHUB_WORKSPACE/target/release/sim_eval"

      - name: Verify sim_eval supports evidence-pack commands
        run: |
          $SIM_EVAL_BIN --help | grep -q "verify-evidence-pack" || (echo "ERROR: sim_eval missing verify-evidence-pack command" && exit 1)
          $SIM_EVAL_BIN --help | grep -q "verify-evidence-tree" || (echo "ERROR: sim_eval missing verify-evidence-tree command" && exit 1)
          echo "✓ sim_eval binary validated"

      - name: Run Phase AB Promotion Gate
        id: gate
        run: |
          set +e
          python3 -m batch_runs.phase_ab.cli gate \
            --auto-generate-phasea \
            --out-dir runs/ci/phase_ab_gate \
            --seed ${{ github.event.inputs.seed || '24680' }} \
            --n-bootstrap ${{ github.event.inputs.n_bootstrap || '1000' }}
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          # Read decision from manifest
          if [ -f runs/ci/phase_ab_gate/phase_ab_manifest.json ]; then
            DECISION=$(python3 -c "import json; d=json.load(open('runs/ci/phase_ab_gate/phase_ab_manifest.json')); print(d['decision'])")
            echo "decision=$DECISION" >> $GITHUB_OUTPUT
          else
            echo "decision=ERROR" >> $GITHUB_OUTPUT
          fi
          
          # Exit with the gate's exit code
          exit $EXIT_CODE

      - name: Verify Phase AB outputs exist
        if: always()
        run: |
          echo "Checking for required outputs..."
          test -f runs/ci/phase_ab_gate/phase_ab_manifest.json && echo "✓ phase_ab_manifest.json"
          test -f runs/ci/phase_ab_gate/confidence_report.json && echo "✓ confidence_report.json"
          test -f runs/ci/phase_ab_gate/confidence_report.md && echo "✓ confidence_report.md"
          test -f runs/ci/phase_ab_gate/evidence_pack/manifest.json && echo "✓ evidence_pack/manifest.json"
          test -f runs/ci/phase_ab_gate/phase_ab_summary.json && echo "✓ phase_ab_summary.json"

      - name: Upload Phase AB gate artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase-ab-gate-artifacts
          path: |
            runs/ci/phase_ab_gate/phase_ab_manifest.json
            runs/ci/phase_ab_gate/confidence_report.json
            runs/ci/phase_ab_gate/confidence_report.md
            runs/ci/phase_ab_gate/phase_ab_summary.json

      - name: Upload Phase AB evidence pack
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase-ab-gate-evidence-pack
          path: runs/ci/phase_ab_gate/evidence_pack

      - name: Generate job summary
        if: always()
        shell: bash
        run: |
          python3 - << 'PYTHON_SCRIPT'
          import json
          import os
          from pathlib import Path

          summary_file = os.environ.get("GITHUB_STEP_SUMMARY", "")
          if not summary_file:
              print("GITHUB_STEP_SUMMARY not set, skipping job summary")
              exit(0)

          # Read manifest
          manifest_path = Path("runs/ci/phase_ab_gate/phase_ab_manifest.json")

          decision = "UNKNOWN"
          candidate_run = "N/A"
          baseline_run = "N/A"
          exit_code = "?"

          if manifest_path.exists():
              with open(manifest_path) as f:
                  manifest = json.load(f)
              decision = manifest.get("decision", "UNKNOWN")
              candidate_run = manifest.get("candidate_run_resolved", "N/A")
              baseline_run = manifest.get("baseline_run_resolved", "N/A")

          # Determine status emoji
          if decision == "PROMOTE":
              status_emoji = "✅"
              status_text = "PASS"
              exit_code = "0"
          elif decision == "REJECT":
              status_emoji = "❌"
              status_text = "FAIL"
              exit_code = "1"
          elif decision == "HOLD":
              status_emoji = "⏸"
              status_text = "HOLD"
              exit_code = "2"
          else:
              status_emoji = "❌"
              status_text = "ERROR"
              exit_code = "3"

          # Build summary parts separately to avoid YAML parsing issues
          header = "## Phase AB Promotion Gate Result\n\n"
          field_table = "| Field | Value |\n|-------|-------|\n"
          field_table += f"| **Status** | {status_emoji} {status_text} |\n"
          field_table += f"| **Decision** | `{decision}` |\n"
          field_table += f"| **Exit Code** | `{exit_code}` |\n\n"
          
          exit_codes = "### Exit Code Contract (Strict Mode)\n\n"
          exit_codes += "| Exit Code | Meaning |\n|-----------|--------|\n"
          exit_codes += "| 0 | PASS (PROMOTE - candidate is provably better) |\n"
          exit_codes += "| 1 | FAIL (REJECT - candidate fails guardrails) |\n"
          exit_codes += "| 2 | HOLD (insufficient evidence - needs more data) |\n"
          exit_codes += "| 3 | ERROR (runtime/IO/parsing failure) |\n\n"
          
          paths = "### Resolved Paths\n\n"
          paths += "| Run | Path |\n|-----|------|\n"
          paths += f"| **Candidate** | `{candidate_run}` |\n"
          paths += f"| **Baseline** | `{baseline_run}` |\n\n"
          
          artifacts = "### Artifacts\n\n"
          artifacts += "- **phase-ab-gate-artifacts**: JSON/MD outputs (manifest, confidence reports, summary)\n"
          artifacts += "- **phase-ab-gate-evidence-pack**: Cryptographically verifiable evidence pack\n\n"
          
          verify = "### Verification\n\n"
          verify += "After downloading artifacts, verify evidence pack integrity:\n\n"
          verify += "```bash\n"
          verify += "unzip phase-ab-gate-evidence-pack.zip -d evidence\n"
          verify += "python3 -m batch_runs.phase_ab.cli verify-evidence evidence/evidence_pack\n"
          verify += "```\n\n"
          
          footer = "---\n*Generated by Phase AB Promotion Gate (strict mode)*\n"
          
          summary = header + field_table + exit_codes + paths + artifacts + verify + footer

          with open(summary_file, "a") as f:
              f.write(summary)

          print("Job summary written successfully")
          PYTHON_SCRIPT

  # ---------------------------------------------------------------------------
  # Auto-deploy job: runs only when gate decision is PROMOTE and deploy=true.
  # Executes the graduated deploy pipeline (shadow -> paper -> canary -> live)
  # on the self-hosted VPS runner.
  # ---------------------------------------------------------------------------
  auto-deploy:
    needs: phase-ab-promotion-gate
    if: >-
      github.event.inputs.deploy == 'true' &&
      needs.phase-ab-promotion-gate.outputs.decision == 'PROMOTE'
    runs-on: ["self-hosted", "Linux", "X64", "vpsb-ci"]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download gate artifacts
        uses: actions/download-artifact@v4
        with:
          name: phase-ab-gate-artifacts
          path: runs/ci/phase_ab_gate

      - name: Generate promoted .env from gate manifest
        run: |
          python3 - << 'EXTRACT_SCRIPT'
          import json, sys
          from pathlib import Path

          manifest_path = Path("runs/ci/phase_ab_gate/phase_ab_manifest.json")
          if not manifest_path.exists():
              print("ERROR: Gate manifest not found.")
              sys.exit(1)

          manifest = json.load(open(manifest_path))
          decision = manifest.get("decision", "UNKNOWN")
          print(f"Gate decision: {decision}")
          if decision != "PROMOTE":
              print(f"ERROR: Expected PROMOTE, got {decision}")
              sys.exit(1)

          # Look for the candidate's mc_summary.json to extract config knobs.
          candidate_dir = Path(manifest["candidate_run_resolved"])
          mc_dir = candidate_dir / "monte_carlo"
          mc_summary = mc_dir / "mc_summary.json" if mc_dir.exists() else None

          # Also check for a Phase A promoted env in the candidate dir.
          promoted_envs = list(candidate_dir.glob("*.env"))

          config_knobs = {}
          if promoted_envs:
              # Use the existing promoted .env file directly.
              env_file = promoted_envs[0]
              print(f"Found existing promoted env: {env_file}")
              for line in env_file.read_text().splitlines():
                  line = line.strip()
                  if not line or line.startswith("#"):
                      continue
                  if line.startswith("export "):
                      line = line[7:].strip()
                  if "=" in line:
                      k, v = line.split("=", 1)
                      config_knobs[k.strip()] = v.strip()
          elif mc_summary and mc_summary.exists():
              # Extract config from mc_summary.json.
              summary = json.load(open(mc_summary))
              cfg = summary.get("config", {})
              if "risk_profile" in cfg:
                  config_knobs["PARAPHINA_RISK_PROFILE"] = cfg["risk_profile"]
              for key in ["hedge_band_base", "mm_size_eta", "vol_ref",
                          "daily_loss_limit", "init_q_tao", "hedge_max_step"]:
                  if key in cfg:
                      env_key = f"PARAPHINA_{key.upper()}"
                      config_knobs[env_key] = str(cfg[key])
          else:
              print("WARNING: No config source found. Using default profile.")
              config_knobs["PARAPHINA_RISK_PROFILE"] = "balanced"

          # Write promoted.env
          out_path = Path("runs/ci/phase_ab_gate/promoted.env")
          with open(out_path, "w") as f:
              f.write("# Auto-generated promoted config from Phase AB gate\n")
              f.write(f"# Decision: {decision}\n")
              f.write(f"# Candidate: {manifest.get('candidate_run_resolved', 'N/A')}\n")
              f.write(f"# Timestamp: {manifest.get('timestamp', 'N/A')}\n\n")
              for k, v in sorted(config_knobs.items()):
                  f.write(f"{k}={v}\n")

          print(f"Wrote promoted.env with {len(config_knobs)} config knobs")
          for k, v in sorted(config_knobs.items()):
              print(f"  {k}={v}")
          EXTRACT_SCRIPT

      - name: Run graduated deploy pipeline
        id: deploy
        run: |
          STOP_BEFORE="${{ github.event.inputs.deploy_stop_before }}"
          STOP_ARG=""
          if [ -n "$STOP_BEFORE" ]; then
            STOP_ARG="--stop-before $STOP_BEFORE"
          fi

          set +e
          python3 deploy/deploy_orchestrator.py deploy \
            runs/ci/phase_ab_gate/promoted.env \
            --config-dir /etc/paraphina \
            --health-url http://127.0.0.1:9898 \
            --shadow-soak ${{ github.event.inputs.shadow_soak || '300' }} \
            --paper-soak ${{ github.event.inputs.paper_soak || '600' }} \
            --canary-soak ${{ github.event.inputs.canary_soak || '900' }} \
            $STOP_ARG 2>&1 | tee deploy_output.log
          DEPLOY_EXIT=$?
          echo "deploy_exit_code=$DEPLOY_EXIT" >> $GITHUB_OUTPUT
          exit $DEPLOY_EXIT

      - name: Upload deploy logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-logs
          path: |
            deploy_output.log
            runs/ci/phase_ab_gate/promoted.env

      - name: Generate deploy summary
        if: always()
        shell: bash
        run: |
          python3 - << 'PYTHON_SCRIPT'
          import os

          deploy_exit = "${{ steps.deploy.outputs.deploy_exit_code }}"
          summary_file = os.environ.get("GITHUB_STEP_SUMMARY", "")
          if not summary_file:
              exit(0)

          if deploy_exit == "0":
              status = "SUCCESS"
              emoji = "✅"
          else:
              status = "FAILED (rolled back)"
              emoji = "❌"

          stop_before = "${{ github.event.inputs.deploy_stop_before }}" or "(none)"
          shadow = "${{ github.event.inputs.shadow_soak }}" or "300"
          paper = "${{ github.event.inputs.paper_soak }}" or "600"
          canary = "${{ github.event.inputs.canary_soak }}" or "900"

          summary = f"""
          ## Auto-Deploy Result

          | Field | Value |
          |-------|-------|
          | **Status** | {emoji} {status} |
          | **Exit Code** | `{deploy_exit}` |
          | **Stop Before** | `{stop_before}` |
          | **Shadow Soak** | {shadow}s |
          | **Paper Soak** | {paper}s |
          | **Canary Soak** | {canary}s |

          ---
          *Generated by Auto-Deploy Pipeline*
          """

          with open(summary_file, "a") as f:
              f.write(summary)
          print("Deploy summary written")
          PYTHON_SCRIPT

